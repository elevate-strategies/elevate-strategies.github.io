<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FEMA Floodplain Lookup - Harris County, TX</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 70vh;
            width: 100%;
        }
        #info {
            padding: 20px;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        #results {
            padding: 20px;
            background: #fff;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .error {
            color: #d32f2f;
            padding: 10px;
            background: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #388e3c;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 4px;
            margin: 10px 0;
        }
        .zone-info {
            margin: 10px 0;
            padding: 15px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
        }
        .zone-info strong {
            font-size: 1.2em;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>FEMA Floodplain Lookup - Harris County, TX</h1>
        <p>Location: <span id="coords">Loading...</span></p>
    </div>
    
    <div id="map"></div>
    
    <div id="results">
        <h2>Flood Zone Information</h2>
        <div id="zone-results">
            <p class="loading">Loading flood zone data...</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" onload="initMap()"></script>
    <script>
        // Global variables
        let map, marker;
        
        // Harris County approximate bounds
        const HARRIS_COUNTY_BOUNDS = {
            west: -95.9,
            south: 29.5,
            east: -94.9,
            north: 30.2
        };

        // Get URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                lat: parseFloat(params.get('lat')),
                lng: parseFloat(params.get('lng'))
            };
        }

        // Query FEMA flood zone at specific location
        async function queryFEMAFloodZone(lat, lng) {
            const resultsDiv = document.getElementById('zone-results');
            
            try {
                // FEMA WMS GetFeatureInfo request
                const bbox = [
                    lng - 0.0001,
                    lat - 0.0001,
                    lng + 0.0001,
                    lat + 0.0001
                ].join(',');
                
                const width = 101;
                const height = 101;
                const x = 50;
                const y = 50;
                
                const url = `https://hazards.fema.gov/gis/nfhl/services/public/NFHL/MapServer/WMSServer?` +
                    `SERVICE=WMS&` +
                    `VERSION=1.3.0&` +
                    `REQUEST=GetFeatureInfo&` +
                    `LAYERS=28&` +
                    `QUERY_LAYERS=28&` +
                    `BBOX=${bbox}&` +
                    `CRS=EPSG:4326&` +
                    `WIDTH=${width}&` +
                    `HEIGHT=${height}&` +
                    `I=${x}&` +
                    `J=${y}&` +
                    `INFO_FORMAT=application/json`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    const props = feature.properties;
                    
                    const floodZone = props.FLD_ZONE || props.ZONE_SUBTY || 'Unknown';
                    const floodway = props.FLOODWAY || 'No';
                    const staticBFE = props.STATIC_BFE || 'N/A';
                    
                    let zoneDescription = getZoneDescription(floodZone);
                    
                    resultsDiv.innerHTML = `
                        <div class="zone-info">
                            <p><strong>Flood Zone: ${floodZone}</strong></p>
                            <p>${zoneDescription}</p>
                            ${floodway === 'FLOODWAY' ? '<p><strong>⚠️ This location is in a FLOODWAY</strong></p>' : ''}
                            ${staticBFE !== 'N/A' ? `<p>Base Flood Elevation: ${staticBFE} feet</p>` : ''}
                        </div>
                    `;
                    
                    if (marker) {
                        marker.bindPopup(`<b>Flood Zone: ${floodZone}</b><br>${zoneDescription}`).openPopup();
                    }
                } else {
                    resultsDiv.innerHTML = 
                        '<div class="success">No FEMA flood zone data found at this location. This may indicate the area is outside mapped flood zones (typically considered Zone X - minimal flood risk).</div>';
                    if (marker) {
                        marker.bindPopup('No flood zone data available').openPopup();
                    }
                }
                
            } catch (error) {
                console.error('Error querying FEMA data:', error);
                resultsDiv.innerHTML = 
                    `<div class="error">Error querying flood data: ${error.message}<br><br>` +
                    `This may be due to CORS restrictions or FEMA service availability. ` +
                    `The map layer should still show flood zones visually.</div>`;
            }
        }

        function getZoneDescription(zone) {
            const descriptions = {
                'A': 'High risk flood area with 1% annual chance of flooding. No Base Flood Elevations determined.',
                'AE': 'High risk flood area with 1% annual chance of flooding. Base Flood Elevations determined.',
                'AH': 'High risk area with shallow flooding (1-3 feet) with 1% annual chance.',
                'AO': 'High risk area with sheet flow flooding with 1% annual chance.',
                'VE': 'High risk coastal area with velocity hazard (wave action) and 1% annual chance of flooding.',
                'V': 'High risk coastal area with velocity hazard. No Base Flood Elevations determined.',
                'X': 'Moderate to low risk area. May be protected by levees or outside 500-year floodplain.',
                'AREA OF MINIMAL FLOOD HAZARD': 'Minimal flood risk area.',
                '0.2 PCT ANNUAL CHANCE FLOOD HAZARD': 'Moderate risk area with 0.2% (500-year) flood chance.'
            };
            
            return descriptions[zone] || 'See FEMA documentation for zone details.';
        }

        // Initialize the map - this runs after the script tag loads
        function initMap() {
            const params = getUrlParams();

            // Use example coordinates if none provided
            if (isNaN(params.lat) || isNaN(params.lng)) {
                params.lat = 29.800967;
                params.lng = -95.370058;
                document.getElementById('coords').textContent = 
                    `${params.lat.toFixed(6)}, ${params.lng.toFixed(6)} (example)`;
                document.getElementById('zone-results').innerHTML = 
                    '<p class="loading">Loading example location. Provide coordinates via URL: ?lat=YOUR_LAT&lng=YOUR_LNG</p>';
            } else {
                document.getElementById('coords').textContent = 
                    `${params.lat.toFixed(6)}, ${params.lng.toFixed(6)}`;
            }
            
            // Create map centered on the location
            map = L.map('map').setView([params.lat, params.lng], 15);
            
            // Add marker
            marker = L.marker([params.lat, params.lng]).addTo(map)
                .bindPopup('Querying location...')
                .openPopup();

            // Add base map
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Add FEMA flood zones layer with Harris County bounding box
            const bbox = `${HARRIS_COUNTY_BOUNDS.west},${HARRIS_COUNTY_BOUNDS.south},${HARRIS_COUNTY_BOUNDS.east},${HARRIS_COUNTY_BOUNDS.north}`;
            
            L.tileLayer.wms('https://hazards.fema.gov/gis/nfhl/services/public/NFHL/MapServer/WMSServer', {
                layers: '28',
                format: 'image/png',
                transparent: true,
                version: '1.3.0',
                crs: L.CRS.EPSG4326,
                attribution: 'FEMA National Flood Hazard Layer - Harris County, TX'
            }).addTo(map);
            
            // Add Harris County boundary outline (approximate rectangle)
            L.rectangle([
                [HARRIS_COUNTY_BOUNDS.south, HARRIS_COUNTY_BOUNDS.west],
                [HARRIS_COUNTY_BOUNDS.north, HARRIS_COUNTY_BOUNDS.east]
            ], {
                color: '#ff7800',
                weight: 2,
                fillOpacity: 0,
                dashArray: '5, 10'
            }).addTo(map).bindPopup('Harris County Boundary (approximate)');
            
            // Query FEMA data
            queryFEMAFloodZone(params.lat, params.lng);
        }
    </script>
</body>
</html>
